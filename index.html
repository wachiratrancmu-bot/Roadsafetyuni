<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>SafeRoad TH ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏á‡∏ñ‡∏ô‡∏ô</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SafeRoad TH ‚Äî Production v5
   Design: Light/Clean Institutional
   Font: IBM Plex Sans Thai
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root {
  --white:    #ffffff;
  --bg:       #f4f6f9;
  --bg2:      #eef1f6;
  --surface:  #ffffff;
  --surface2: #f7f9fc;
  --surface3: #edf0f5;
  --border:   #d4dae4;
  --border2:  #b8c2d0;
  --divider:  #e8ecf1;
  --navy:     #1b3a6b;
  --navy-d:   #122b54;
  --navy-m:   #2653a0;
  --navy-l:   #e8edf7;
  --navy-xl:  #f0f4fb;
  --red:      #c0392b; --red-m:#e74c3c; --red-l:#fdf0ef; --red-b:#f9c9c5;
  --amber:    #b7560a; --amber-m:#e67e22; --amber-l:#fdf4ec; --amber-b:#f7d9bc;
  --green:    #1a7a4a; --green-m:#27ae60; --green-l:#edf8f2; --green-b:#b8e6cf;
  --blue:     #2563eb; --blue-l:#eff6ff; --blue-b:#bfdbfe;
  --text:     #1a2332; --text-2:#3d5168; --text-3:#6b7f99; --text-4:#9aaabb;
  --font:     'IBM Plex Sans Thai', sans-serif;
  --mono:     'IBM Plex Mono', monospace;
  --r-xs:4px; --r-sm:6px; --r:10px; --r-lg:14px; --r-xl:18px;
  --sh-xs:0 1px 3px rgba(27,58,107,.06);
  --sh:0 2px 8px rgba(27,58,107,.08),0 1px 2px rgba(27,58,107,.04);
  --sh-md:0 4px 16px rgba(27,58,107,.10),0 1px 4px rgba(27,58,107,.06);
  --sh-lg:0 8px 32px rgba(27,58,107,.12),0 2px 8px rgba(27,58,107,.06);
  --sh-panel:0 -4px 24px rgba(27,58,107,.10);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{font-family:var(--font);background:var(--bg);color:var(--text);height:100%;overflow:hidden;-webkit-font-smoothing:antialiased}

/* ‚ïê‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê‚ïê */
#login-screen{
  position:fixed;inset:0;z-index:9000;
  background:var(--navy);
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  padding:24px;
  transition:opacity .4s ease,transform .4s ease;
}
#login-screen.hide{opacity:0;transform:scale(1.04);pointer-events:none}

.login-logo{
  width:72px;height:72px;
  background:rgba(255,255,255,.12);
  border:2px solid rgba(255,255,255,.2);
  border-radius:20px;
  display:flex;align-items:center;justify-content:center;
  margin-bottom:20px;
}
.login-logo svg{width:36px;height:36px}

.login-title{
  font-size:20px;font-weight:700;color:var(--white);
  text-align:center;margin-bottom:4px;
}
.login-sub{
  font-size:12px;color:rgba(255,255,255,.55);
  text-align:center;margin-bottom:32px;letter-spacing:.3px;
}

.login-card{
  width:100%;max-width:380px;
  background:var(--white);
  border-radius:var(--r-xl);
  padding:28px 24px;
  box-shadow:0 20px 60px rgba(0,0,0,.25);
}

.lc-label{
  display:block;font-size:11px;font-weight:700;
  color:var(--navy);text-transform:uppercase;
  letter-spacing:.6px;margin-bottom:6px;margin-top:16px;
}
.lc-label:first-child{margin-top:0}

.lc-input{
  width:100%;padding:12px 14px;
  background:var(--surface2);
  border:1.5px solid var(--border);
  border-radius:var(--r-sm);
  font-family:var(--mono);font-size:16px;
  color:var(--text);outline:none;
  transition:border-color .15s;
  letter-spacing:1px;
}
.lc-input:focus{border-color:var(--navy);background:var(--white)}
.lc-input::placeholder{color:var(--text-4);font-family:var(--font);letter-spacing:0}
.lc-input.error{border-color:var(--red);background:var(--red-l)}

.lc-select{
  width:100%;padding:12px 14px;
  background:var(--surface2);
  border:1.5px solid var(--border);
  border-radius:var(--r-sm);
  font-family:var(--font);font-size:14px;
  color:var(--text);outline:none;
  transition:border-color .15s;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7f99' stroke-width='2.5'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 12px center;
  padding-right:36px;
}
.lc-select:focus{border-color:var(--navy)}

.lc-detected{
  display:none;margin-top:6px;padding:8px 11px;
  background:var(--green-l);border:1px solid var(--green-b);
  border-radius:var(--r-sm);font-size:12px;color:var(--green);
  font-weight:600;align-items:center;gap:6px;
}
.lc-detected.show{display:flex}

.lc-error{
  display:none;margin-top:6px;padding:8px 11px;
  background:var(--red-l);border:1px solid var(--red-b);
  border-radius:var(--r-sm);font-size:12px;color:var(--red);font-weight:600;
}
.lc-error.show{display:block}

.login-btn{
  width:100%;margin-top:20px;padding:15px;
  background:var(--navy);color:var(--white);
  border:none;border-radius:var(--r-sm);
  font-family:var(--font);font-size:15px;font-weight:700;
  cursor:pointer;transition:all .15s;
  box-shadow:0 4px 16px rgba(27,58,107,.3);
  letter-spacing:.1px;
}
.login-btn:hover{background:var(--navy-d)}
.login-btn:active{transform:scale(.99)}
.login-btn:disabled{opacity:.6;pointer-events:none}

.login-note{
  margin-top:12px;font-size:11px;color:var(--text-4);
  text-align:center;line-height:1.6;
}

/* ‚ïê‚ïê‚ïê‚ïê MAIN APP (hidden until login) ‚ïê‚ïê‚ïê‚ïê */
#app{display:none}
#app.show{display:block}

/* ‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê */
.header{
  position:fixed;top:0;left:0;right:0;height:56px;
  background:var(--navy);
  display:flex;align-items:center;padding:0 16px;
  z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,.18);
}
.header-emblem{
  width:32px;height:32px;background:var(--white);
  border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.header-emblem svg{width:18px;height:18px}
.header-wordmark{margin-left:10px}
.header-title{font-size:13px;font-weight:700;color:var(--white);line-height:1.2}
.header-sub{font-size:9.5px;color:rgba(255,255,255,.55);line-height:1.2}
.header-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.header-counters{
  display:flex;align-items:center;gap:2px;
  background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);
  border-radius:var(--r-sm);padding:5px 8px;
}
.hcnt{display:flex;align-items:center;gap:4px;padding:0 6px;border-right:1px solid rgba(255,255,255,.12)}
.hcnt:last-child{border-right:none}
.hcnt-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.hcnt-n{font-family:var(--mono);font-size:12px;font-weight:600;color:var(--white)}
.user-pill{
  display:flex;align-items:center;gap:6px;
  padding:5px 10px;
  background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);
  border-radius:var(--r-sm);cursor:pointer;
}
.user-av{
  width:22px;height:22px;border-radius:50%;
  background:rgba(255,255,255,.9);color:var(--navy);
  font-size:11px;font-weight:800;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.user-name{font-size:11px;font-weight:600;color:rgba(255,255,255,.85);max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ‚ïê‚ïê‚ïê‚ïê STATUS BAR ‚ïê‚ïê‚ïê‚ïê */
.status-bar{
  position:fixed;top:56px;left:0;right:0;height:38px;
  background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 12px;gap:8px;
  z-index:990;box-shadow:var(--sh-xs);
}
.sb-live{display:flex;align-items:center;gap:5px;font-size:10.5px;font-weight:600;color:var(--green)}
.sb-live-dot{width:7px;height:7px;border-radius:50%;background:var(--green-m);animation:pulse 2.2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.85)}}
.sb-sep{width:1px;height:16px;background:var(--divider)}
.sb-modes{display:flex;background:var(--bg);border:1px solid var(--border);border-radius:var(--r-sm);overflow:hidden}
.sb-mode-btn{
  padding:5px 10px;font-family:var(--font);font-size:10.5px;font-weight:600;
  color:var(--text-3);background:none;border:none;border-right:1px solid var(--border);
  cursor:pointer;transition:all .15s;white-space:nowrap;
}
.sb-mode-btn:last-child{border-right:none}
.sb-mode-btn.active{background:var(--navy);color:var(--white)}
.sb-right{margin-left:auto;display:flex;align-items:center;gap:6px}
.sb-pts{
  font-family:var(--mono);font-size:11px;font-weight:600;color:var(--navy);
  background:var(--navy-xl);border:1px solid var(--navy-l);
  border-radius:var(--r-sm);padding:4px 10px;
}

/* ‚ïê‚ïê‚ïê‚ïê MAP ‚ïê‚ïê‚ïê‚ïê */
#map{position:fixed;top:94px;left:0;right:0;bottom:60px;z-index:1}
.leaflet-container{font-family:var(--font)!important}
.leaflet-popup-content-wrapper{border-radius:var(--r)!important;box-shadow:var(--sh-md)!important;border:1px solid var(--border)!important;padding:0!important}
.leaflet-popup-content{margin:0!important}
.leaflet-popup-tip-container{display:none}

/* ‚ïê‚ïê‚ïê‚ïê MAP OVERLAY ‚ïê‚ïê‚ïê‚ïê */
.map-legend{
  position:fixed;bottom:70px;left:12px;
  background:rgba(255,255,255,.95);border:1px solid var(--border);
  border-radius:var(--r);padding:10px 12px;z-index:500;
  backdrop-filter:blur(8px);box-shadow:var(--sh-md);
}
.leg-title{font-size:9px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:7px}
.leg-row{display:flex;align-items:center;gap:7px;margin-bottom:4px;font-size:11px;font-weight:500;color:var(--text-2)}
.leg-row:last-child{margin-bottom:0}
.leg-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.map-fabs{position:fixed;right:12px;bottom:70px;display:flex;flex-direction:column;gap:8px;z-index:500}
.map-fab{
  width:44px;height:44px;background:var(--surface);
  border:1px solid var(--border);border-radius:var(--r);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;box-shadow:var(--sh-md);transition:all .15s;
  font-size:17px;color:var(--text-2);
}
.map-fab:active{transform:scale(.95)}
.map-fab-report{
  width:50px;height:50px;background:var(--navy);border-color:var(--navy-d);
  color:var(--white);border-radius:var(--r);
  box-shadow:0 4px 16px rgba(27,58,107,.35);
}

/* ‚ïê‚ïê‚ïê‚ïê BOTTOM NAV ‚ïê‚ïê‚ïê‚ïê */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;height:60px;
  background:var(--surface);border-top:1.5px solid var(--border);
  display:flex;z-index:1000;box-shadow:0 -2px 12px rgba(27,58,107,.07);
}
.nav-item{
  flex:1;display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:2px;background:none;border:none;
  cursor:pointer;font-family:var(--font);font-size:9.5px;font-weight:600;
  color:var(--text-4);transition:all .15s;position:relative;
}
.nav-item.active{color:var(--navy)}
.nav-item.active::after{
  content:'';position:absolute;top:0;left:25%;right:25%;
  height:2px;background:var(--navy);border-radius:0 0 2px 2px;
}
.nav-icon{width:28px;height:22px;display:flex;align-items:center;justify-content:center;font-size:18px}
.nav-item.active .nav-icon{transform:translateY(-1px)}
.nav-center{
  flex:1;display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:2px;background:none;border:none;
  cursor:pointer;font-family:var(--font);font-size:9.5px;font-weight:700;color:var(--navy);
}
.nav-center-icon{
  width:42px;height:34px;background:var(--navy);border-radius:var(--r-sm);
  display:flex;align-items:center;justify-content:center;
  color:var(--white);font-size:18px;margin-top:-10px;
  box-shadow:0 2px 10px rgba(27,58,107,.3);
}

/* ‚ïê‚ïê‚ïê‚ïê OVERLAY & PANEL ‚ïê‚ïê‚ïê‚ïê */
.overlay{
  position:fixed;inset:0;background:rgba(10,18,35,.45);
  z-index:1500;opacity:0;pointer-events:none;
  transition:opacity .3s ease;backdrop-filter:blur(2px);
}
.overlay.open{opacity:1;pointer-events:all}
.panel{
  position:fixed;bottom:0;left:0;right:0;
  background:var(--surface);border-radius:var(--r-xl) var(--r-xl) 0 0;
  z-index:1600;transform:translateY(100%);
  transition:transform .38s cubic-bezier(.32,.72,0,1);
  display:flex;flex-direction:column;max-height:93vh;
  box-shadow:var(--sh-panel);border-top:1px solid var(--border);
}
.panel.open{transform:translateY(0)}
.panel-handle-wrap{display:flex;justify-content:center;padding:10px 0 0;flex-shrink:0}
.panel-handle{width:38px;height:4px;background:var(--border2);border-radius:2px}
.panel-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 18px 8px;border-bottom:1px solid var(--divider);flex-shrink:0;
}
.ph-left{display:flex;align-items:center;gap:10px}
.ph-icon{
  width:34px;height:34px;background:var(--navy-xl);border:1px solid var(--navy-l);
  border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;
  font-size:16px;flex-shrink:0;
}
.panel-title{font-size:15px;font-weight:700;color:var(--text);line-height:1.2}
.panel-subtitle{font-size:11px;color:var(--text-3);font-weight:400;margin-top:1px}
.panel-close{
  width:30px;height:30px;background:var(--surface2);border:1px solid var(--border);
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:13px;color:var(--text-3);transition:all .15s;flex-shrink:0;
}
.panel-close:hover{background:var(--surface3);color:var(--text)}
.panel-body{
  flex:1;overflow-y:auto;padding:0 18px 160px;
  -webkit-overflow-scrolling:touch;scroll-behavior:smooth;
}
.panel-body::-webkit-scrollbar{display:none}

/* ‚ïê‚ïê‚ïê‚ïê STEPPER ‚ïê‚ïê‚ïê‚ïê */
.wizard-stepper{padding:14px 18px 0;flex-shrink:0}
.step-track{display:flex;align-items:center;margin-bottom:8px}
.step-node{
  display:flex;align-items:center;justify-content:center;
  width:26px;height:26px;border-radius:50%;
  font-family:var(--mono);font-size:11px;font-weight:600;
  flex-shrink:0;transition:all .25s;
  border:2px solid var(--border2);background:var(--surface);color:var(--text-3);z-index:1;
}
.step-node.done{background:var(--navy);border-color:var(--navy);color:var(--white)}
.step-node.active{background:var(--navy);border-color:var(--navy);color:var(--white);box-shadow:0 0 0 4px rgba(27,58,107,.12)}
.step-connector{flex:1;height:2px;background:var(--border);margin:0 4px;transition:background .3s;border-radius:1px}
.step-connector.done{background:var(--navy)}
.step-info{display:flex;align-items:center;justify-content:space-between;padding-bottom:10px;border-bottom:1px solid var(--divider)}
.step-label-txt{font-size:12px;font-weight:700;color:var(--navy);letter-spacing:.1px}
.step-counter-txt{font-family:var(--mono);font-size:11px;color:var(--text-4);font-weight:500}

/* ‚ïê‚ïê‚ïê‚ïê FORM COMPONENTS ‚ïê‚ïê‚ïê‚ïê */
.field-sect{margin-top:18px;margin-bottom:9px}
.field-label{display:block;font-size:11px;font-weight:700;color:var(--navy);text-transform:uppercase;letter-spacing:.7px;margin-bottom:3px}
.field-req{color:var(--red);margin-left:3px}
.field-desc{font-size:11.5px;color:var(--text-3);font-weight:400;line-height:1.4}

/* Event type big rows */
.event-opts{display:flex;flex-direction:column;gap:8px}
.event-opt{
  display:flex;align-items:center;gap:14px;padding:13px 14px;
  background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);
  cursor:pointer;transition:all .15s;text-align:left;width:100%;font-family:var(--font);
}
.event-opt:active{transform:scale(.99)}
.ev-icon{width:40px;height:40px;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.ev-text{flex:1}
.ev-title{font-size:13.5px;font-weight:700;color:var(--text);margin-bottom:2px}
.ev-desc{font-size:11.5px;color:var(--text-3);line-height:1.35}
.ev-radio{width:20px;height:20px;border-radius:50%;border:2px solid var(--border);flex-shrink:0;transition:all .15s}

.event-opt[data-sev=accident]{border-left:4px solid var(--red-m)}
.event-opt[data-sev=frequent]{border-left:4px solid var(--amber-m)}
.event-opt[data-sev=near]{border-left:4px solid var(--green-m)}
.event-opt[data-sev=observe]{border-left:4px solid var(--navy-m)}
.event-opt[data-sev=accident] .ev-icon{background:var(--red-l)}
.event-opt[data-sev=frequent] .ev-icon{background:var(--amber-l)}
.event-opt[data-sev=near] .ev-icon{background:var(--green-l)}
.event-opt[data-sev=observe] .ev-icon{background:var(--navy-xl)}
.event-opt.sel[data-sev=accident]{background:var(--red-l);border-color:var(--red-m);border-left:4px solid var(--red)}
.event-opt.sel[data-sev=frequent]{background:var(--amber-l);border-color:var(--amber-m);border-left:4px solid var(--amber)}
.event-opt.sel[data-sev=near]{background:var(--green-l);border-color:var(--green-m);border-left:4px solid var(--green)}
.event-opt.sel[data-sev=observe]{background:var(--navy-xl);border-color:var(--navy-m);border-left:4px solid var(--navy)}
.event-opt.sel .ev-radio{background:var(--navy);border-color:var(--navy)}

.injury-sub{display:none;margin-top:14px;padding:14px;background:var(--red-l);border:1px solid var(--red-b);border-radius:var(--r)}
.injury-sub.show{display:block}

/* Grid options */
.opts-2{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.opts-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px}
.opts-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px}
.opt-card{
  display:flex;flex-direction:column;align-items:center;gap:5px;
  padding:11px 6px 9px;background:var(--surface);border:1.5px solid var(--border);
  border-radius:var(--r-sm);cursor:pointer;transition:all .13s;
  font-family:var(--font);font-size:11.5px;font-weight:500;color:var(--text-2);
  text-align:center;line-height:1.25;-webkit-user-select:none;user-select:none;
}
.opt-icon{font-size:22px;line-height:1}
.opt-card:active{transform:scale(.97)}
.opt-card.sel{border-color:var(--navy);background:var(--navy-xl);color:var(--navy);font-weight:700}

/* Pill row */
.pill-row{display:flex;flex-wrap:wrap;gap:6px}
.pill-opt{
  display:flex;align-items:center;gap:5px;padding:7px 12px;
  background:var(--surface);border:1.5px solid var(--border);border-radius:100px;
  cursor:pointer;font-family:var(--font);font-size:12px;font-weight:500;color:var(--text-2);
  transition:all .13s;white-space:nowrap;-webkit-user-select:none;user-select:none;
}
.pill-opt:active{transform:scale(.97)}
.pill-opt.sel{background:var(--navy);border-color:var(--navy);color:var(--white);font-weight:600}

/* GPS row */
.gps-row{display:flex;gap:8px;align-items:stretch}
.gps-btn{
  display:flex;align-items:center;gap:7px;padding:10px 14px;
  background:var(--blue-l);border:1.5px solid var(--blue-b);border-radius:var(--r-sm);
  color:var(--blue);font-family:var(--font);font-size:12.5px;font-weight:700;
  cursor:pointer;transition:all .15s;white-space:nowrap;flex-shrink:0;
}
.gps-btn:active{background:#dbeafe}
.gps-btn.loading{opacity:.7;pointer-events:none}
.coord-box{
  flex:1;padding:9px 12px;background:var(--surface2);border:1.5px solid var(--border);
  border-radius:var(--r-sm);font-family:var(--mono);font-size:11px;color:var(--text-4);
  display:flex;align-items:center;gap:6px;min-width:0;
}
.coord-box.set{border-color:var(--green-m);color:var(--green);background:var(--green-l)}
.coord-txt{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.map-hint{display:flex;align-items:center;justify-content:center;gap:5px;font-size:11px;color:var(--text-4);padding:5px 0}

/* Inputs */
.form-input{
  width:100%;padding:10px 13px;background:var(--surface);border:1.5px solid var(--border);
  border-radius:var(--r-sm);color:var(--text);font-family:var(--font);font-size:14px;
  outline:none;transition:border-color .15s;
}
.form-input:focus{border-color:var(--navy)}
.form-input::placeholder{color:var(--text-4)}
.form-ta{
  width:100%;padding:10px 13px;background:var(--surface);border:1.5px solid var(--border);
  border-radius:var(--r-sm);color:var(--text);font-family:var(--font);font-size:14px;
  outline:none;resize:none;min-height:88px;line-height:1.6;transition:border-color .15s;
}
.form-ta:focus{border-color:var(--navy)}
.form-ta::placeholder{color:var(--text-4)}

/* Photo */
.photo-zone{
  border:2px dashed var(--border2);border-radius:var(--r);padding:22px 16px;
  text-align:center;cursor:pointer;background:var(--surface2);transition:all .2s;
}
.photo-zone:hover{border-color:var(--navy);background:var(--navy-xl)}
.photo-zone input{display:none}
.pz-icon{font-size:28px;margin-bottom:6px;opacity:.6}
.pz-title{font-size:13px;font-weight:600;color:var(--text-2);margin-bottom:3px}
.pz-sub{font-size:11px;color:var(--text-4)}
.photo-previews{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.photo-thumb{width:68px;height:68px;border-radius:var(--r-sm);object-fit:cover;border:2px solid var(--border)}

.form-div{height:1px;background:var(--divider);margin:16px 0}

/* Wizard footer */
.wiz-footer{
  position:fixed;bottom:60px;left:0;right:0;
  padding:10px 18px;background:var(--surface);border-top:1px solid var(--divider);
  display:none;gap:10px;z-index:1700;box-shadow:0 -2px 8px rgba(27,58,107,.06);
}
.wiz-footer.active{display:flex}
.wf-back{
  padding:13px 18px;background:var(--surface2);border:1.5px solid var(--border);
  border-radius:var(--r-sm);font-family:var(--font);font-size:13.5px;font-weight:600;
  color:var(--text-2);cursor:pointer;transition:all .15s;flex-shrink:0;
}
.wf-back:hover{background:var(--surface3)}
.wf-next{
  flex:1;padding:13px;background:var(--navy);border:none;border-radius:var(--r-sm);
  font-family:var(--font);font-size:13.5px;font-weight:700;color:var(--white);
  cursor:pointer;transition:all .15s;box-shadow:0 2px 10px rgba(27,58,107,.25);
}
.wf-next:hover{background:var(--navy-d)}
.wf-next:active{transform:scale(.99)}
.wf-next.submit{background:var(--green);box-shadow:0 2px 10px rgba(26,122,74,.25)}
.wf-next.loading{opacity:.7;pointer-events:none}

/* ‚ïê‚ïê‚ïê‚ïê FULL VIEWS ‚ïê‚ïê‚ïê‚ïê */
.full-view{
  position:fixed;inset:0;top:94px;bottom:60px;
  background:var(--bg);z-index:800;
  display:none;flex-direction:column;overflow:hidden;
}
.full-view.open{display:flex}
.fv-head{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 16px 10px;flex-shrink:0}
.fv-title-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.fv-title{font-size:15px;font-weight:700;color:var(--text)}
.fv-badge{font-family:var(--mono);font-size:11px;font-weight:600;background:var(--navy);color:var(--white);padding:3px 10px;border-radius:100px}
.filter-chips{display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch}
.filter-chips::-webkit-scrollbar{display:none}
.fchip{
  padding:5px 13px;background:var(--surface);border:1.5px solid var(--border);
  border-radius:100px;font-family:var(--font);font-size:11.5px;font-weight:600;
  color:var(--text-3);cursor:pointer;white-space:nowrap;flex-shrink:0;transition:all .13s;
}
.fchip.active{background:var(--navy);border-color:var(--navy);color:var(--white)}
.fv-body{flex:1;overflow-y:auto;padding:12px 14px 16px;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.fv-body::-webkit-scrollbar{display:none}

/* Report cards */
.rcard{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);overflow:hidden;margin-bottom:8px;
  cursor:pointer;transition:all .13s;box-shadow:var(--sh-xs);
}
.rcard:active{transform:scale(.99)}
.rc-bar{height:3px;width:100%}
.rc-body{padding:11px 13px 10px}
.rc-top{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:5px}
.rc-type{font-size:13px;font-weight:700;color:var(--text)}
.rc-sev{font-size:10px;font-weight:700;padding:2px 9px;border-radius:100px;white-space:nowrap;flex-shrink:0}
.rc-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px}
.rc-tag{font-size:10px;padding:2px 7px;border-radius:3px;background:var(--surface2);border:1px solid var(--border);color:var(--text-3);font-weight:500}
.rc-desc{font-size:12px;color:var(--text-2);line-height:1.5;margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.rc-foot{display:flex;align-items:center;gap:10px;font-size:10.5px;color:var(--text-4)}
.rc-vote{
  margin-left:auto;display:flex;align-items:center;gap:4px;
  padding:4px 10px;background:var(--surface2);border:1px solid var(--border);
  border-radius:100px;font-family:var(--font);font-size:11px;font-weight:600;color:var(--text-3);cursor:pointer;transition:all .13s;
}
.rc-vote.voted{background:var(--navy-xl);border-color:var(--navy-l);color:var(--navy)}

/* ‚ïê‚ïê‚ïê‚ïê PROFILE PANEL ‚ïê‚ïê‚ïê‚ïê */
.prof-card{background:var(--navy);border-radius:var(--r);padding:18px;color:var(--white);margin-bottom:16px;position:relative;overflow:hidden}
.prof-card::before{content:'';position:absolute;right:-24px;top:-24px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.04)}
.pc-name{font-size:17px;font-weight:700;margin-bottom:2px}
.pc-code{font-family:var(--mono);font-size:11px;color:rgba(255,255,255,.5);margin-bottom:2px}
.pc-faculty{font-size:11px;color:rgba(255,255,255,.6);margin-bottom:16px}
.pc-level{font-size:11px;color:rgba(255,255,255,.6)}
.pc-stats{display:flex;gap:20px;margin-bottom:0}
.pcs-n{font-family:var(--mono);font-size:22px;font-weight:700;color:#fbbf24}
.pcs-l{font-size:10px;color:rgba(255,255,255,.55);margin-top:1px}
.pc-xp-bar{height:4px;background:rgba(255,255,255,.15);border-radius:2px;margin:14px 0 5px;overflow:hidden}
.pc-xp-fill{height:100%;background:#fbbf24;border-radius:2px;transition:width .6s ease}
.pc-xp-lbl{font-size:10px;color:rgba(255,255,255,.5)}
.badge-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
.badge-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r-sm);padding:11px 4px;text-align:center}
.badge-card.earned{background:var(--navy-xl);border-color:var(--navy-l)}
.badge-card.locked{opacity:.35}
.badge-icon{font-size:26px;display:block;margin-bottom:4px}
.badge-name{font-size:9.5px;font-weight:600;color:var(--text-3);line-height:1.2}
.badge-card.earned .badge-name{color:var(--navy)}
.pts-table{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r-sm);overflow:hidden}
.pts-row{display:flex;align-items:center;justify-content:space-between;padding:10px 13px;border-bottom:1px solid var(--divider);font-size:12.5px}
.pts-row:last-child{border-bottom:none}
.pts-val{font-family:var(--mono);font-weight:700;color:var(--navy);font-size:12px}

/* Leaderboard */
.lb-card{display:flex;align-items:center;gap:11px;padding:11px 13px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r-sm);margin-bottom:6px;box-shadow:var(--sh-xs)}
.lb-rank{font-family:var(--mono);font-size:12px;font-weight:700;color:var(--text-3);width:28px;text-align:center;flex-shrink:0}
.lb-av{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:var(--white);flex-shrink:0}
.lb-info{flex:1;min-width:0}
.lb-name{font-size:13px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lb-sub{font-size:10.5px;color:var(--text-4)}
.lb-pts{font-family:var(--mono);font-size:13px;font-weight:700;color:var(--navy)}

/* Map popup */
.map-popup{padding:13px 14px;min-width:220px;max-width:270px}
.mp-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.mp-sev-bar{width:4px;border-radius:2px;align-self:stretch;flex-shrink:0}
.mp-title{font-size:13px;font-weight:700;color:var(--text)}
.mp-badge{display:inline-block;font-size:10px;font-weight:700;padding:2px 8px;border-radius:100px;margin-bottom:6px}
.mp-tags{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:6px}
.mp-tag{font-size:10px;padding:2px 7px;border-radius:3px;background:var(--surface2);border:1px solid var(--border);color:var(--text-3)}
.mp-desc{font-size:12px;color:var(--text-2);line-height:1.5;margin-bottom:6px}
.mp-meta{font-size:10.5px;color:var(--text-4)}

/* Section heading */
.sec-head{font-size:11px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:.7px;margin-bottom:10px}

/* Toast */
.toast{
  position:fixed;bottom:76px;left:50%;
  transform:translateX(-50%) translateY(16px);
  background:var(--navy);color:var(--white);padding:10px 20px;
  border-radius:100px;font-size:13px;font-weight:600;white-space:nowrap;
  z-index:9999;opacity:0;pointer-events:none;
  transition:all .3s cubic-bezier(.34,1.56,.64,1);
  box-shadow:0 4px 20px rgba(27,58,107,.25);max-width:90vw;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.err{background:var(--red)}
.toast.ok{background:var(--green)}

/* Misc */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:56px 24px;color:var(--text-4);text-align:center}
.empty-ico{font-size:40px;margin-bottom:12px;opacity:.35}
.empty-txt{font-size:13px}
@keyframes slide-up{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.anim-in{animation:slide-up .22s ease both}

/* Step pages */
.step-page{display:none}
.step-page.active{display:block}

/* login step pages */
.login-step{display:none}
.login-step.active{display:block;animation:slide-up .25s ease both}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOGIN SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="login-screen">
  <div class="login-logo">
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" fill="none" stroke="white" stroke-width="2" stroke-linejoin="round"/>
      <line x1="12" y1="9" x2="12" y2="13" stroke="white" stroke-width="2" stroke-linecap="round"/>
      <circle cx="12" cy="17" r="1" fill="white"/>
    </svg>
  </div>
  <div class="login-title">SafeRoad TH</div>
  <div class="login-sub">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏á‡∏ñ‡∏ô‡∏ô<br>Road Hazard Reporting System</div>

  <div class="login-card">
    <label class="lc-label">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ <span style="color:var(--red)">*</span></label>
    <input
      class="lc-input"
      id="inp-student-id"
      type="text"
      inputmode="numeric"
      maxlength="10"
      placeholder="‡πÄ‡∏ä‡πà‡∏ô 6812207001"
      oninput="onStudentIdInput(this)"
      onblur="validateStudentId()"
    >
    <div class="lc-detected" id="faculty-detected">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
      <span id="faculty-detected-text"></span>
    </div>
    <div class="lc-error" id="id-error"></div>

    <label class="lc-label" style="margin-top:14px">‡∏Ñ‡∏ì‡∏∞ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô <span style="color:var(--red)">*</span></label>
    <select class="lc-select" id="sel-faculty">
      <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ì‡∏∞ ‚Äî</option>
      <option value="01">‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏∏‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
      <option value="02">‡∏Ñ‡∏ì‡∏∞‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
      <option value="03">‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</option>
      <option value="04">‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ</option>
      <option value="05">‡∏Ñ‡∏ì‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
      <option value="06">‡∏Ñ‡∏ì‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°</option>
      <option value="07">‡∏Ñ‡∏ì‡∏∞‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô</option>
      <option value="08">‡∏Ñ‡∏ì‡∏∞‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
      <option value="09">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ / ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</option>
      <option value="99">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
    </select>
    <div class="lc-error" id="faculty-error"></div>

    <label class="lc-label" style="margin-top:14px">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span style="font-weight:400;color:var(--text-4)">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span></label>
    <input class="lc-input" id="inp-fullname" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" style="font-family:var(--font);letter-spacing:0;font-size:14px">

    <button class="login-btn" id="login-btn" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <div class="login-note">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏ñ‡∏ô‡∏ô<br>‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN APP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">

<!-- HEADER -->
<header class="header">
  <div class="header-emblem">
    <svg viewBox="0 0 24 24" fill="none">
      <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" stroke="#1b3a6b" stroke-width="2" stroke-linejoin="round"/>
      <line x1="12" y1="9" x2="12" y2="13" stroke="#1b3a6b" stroke-width="2" stroke-linecap="round"/>
      <circle cx="12" cy="17" r="1" fill="#1b3a6b"/>
    </svg>
  </div>
  <div class="header-wordmark">
    <div class="header-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏á‡∏ñ‡∏ô‡∏ô</div>
    <div class="header-sub">SafeRoad TH ‚Äî Road Hazard Reporting System</div>
  </div>
  <div class="header-right">
    <div class="header-counters">
      <div class="hcnt"><div class="hcnt-dot" style="background:#c0392b"></div><span class="hcnt-n" id="h-a">0</span></div>
      <div class="hcnt"><div class="hcnt-dot" style="background:#e67e22"></div><span class="hcnt-n" id="h-f">0</span></div>
      <div class="hcnt"><div class="hcnt-dot" style="background:#27ae60"></div><span class="hcnt-n" id="h-n">0</span></div>
    </div>
    <div class="user-pill" onclick="openPanel('profile')">
      <div class="user-av" id="hdr-av">?</div>
      <span class="user-name" id="hdr-name">‚Äî</span>
    </div>
  </div>
</header>

<!-- STATUS BAR -->
<div class="status-bar">
  <div class="sb-live"><div class="sb-live-dot"></div>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏î</div>
  <div class="sb-sep"></div>
  <div class="sb-modes">
    <button class="sb-mode-btn active" id="mb-pin" onclick="setMapMode('pin')">‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏∏‡∏î</button>
    <button class="sb-mode-btn" id="mb-heat" onclick="setMapMode('heat')">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô</button>
    <button class="sb-mode-btn" id="mb-cluster" onclick="setMapMode('cluster')">‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
  </div>
  <div class="sb-right">
    <div class="sb-pts" id="hdr-pts">0 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
  </div>
</div>

<!-- MAP -->
<div id="map"></div>

<div class="map-fabs">
  <button class="map-fab" onclick="doGPS()" title="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/>
      <line x1="12" y1="2" x2="12" y2="4"/><line x1="12" y1="20" x2="12" y2="22"/>
      <line x1="2" y1="12" x2="4" y2="12"/><line x1="20" y1="12" x2="22" y2="12"/>
    </svg>
  </button>
  <button class="map-fab map-fab-report" onclick="openReportPanel()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
  </button>
</div>

<div class="map-legend">
  <div class="leg-title">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</div>
  <div class="leg-row"><div class="leg-dot" style="background:#c0392b"></div>‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡πâ‡∏ß</div>
  <div class="leg-row"><div class="leg-dot" style="background:#e67e22"></div>‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡∏ö‡πà‡∏≠‡∏¢ / ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á</div>
  <div class="leg-row"><div class="leg-dot" style="background:#27ae60"></div>‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏</div>
  <div class="leg-row"><div class="leg-dot" style="background:#2563eb"></div>‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-item active" id="ni-map" onclick="showView('map',this)">
    <div class="nav-icon">üó∫Ô∏è</div>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
  </button>
  <button class="nav-item" id="ni-list" onclick="showView('list',this)">
    <div class="nav-icon">üìã</div>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
  </button>
  <button class="nav-center" onclick="openReportPanel()">
    <div class="nav-center-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
    </div>
    ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
  </button>
  <button class="nav-item" id="ni-rank" onclick="showView('rank',this)">
    <div class="nav-icon">üèÜ</div>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö
  </button>
  <button class="nav-item" id="ni-prof" onclick="openPanel('profile')">
    <div class="nav-icon">üë§</div>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
  </button>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê LIST VIEW ‚ïê‚ïê‚ïê‚ïê -->
<div class="full-view" id="fv-list">
  <div class="fv-head">
    <div class="fv-title-row">
      <span class="fv-title">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
      <span class="fv-badge" id="list-count">0</span>
    </div>
    <div class="filter-chips">
      <button class="fchip active" onclick="filterList('all',this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button class="fchip" onclick="filterList('accident',this)">üî¥ ‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏</button>
      <button class="fchip" onclick="filterList('frequent',this)">üü° ‡πÄ‡∏Å‡∏¥‡∏î‡∏ö‡πà‡∏≠‡∏¢</button>
      <button class="fchip" onclick="filterList('near',this)">üü¢ ‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÄ‡∏Å‡∏¥‡∏î</button>
      <button class="fchip" onclick="filterList('observe',this)">üîµ ‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡πÄ‡∏´‡πá‡∏ô</button>
    </div>
  </div>
  <div class="fv-body" id="list-body"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê RANK VIEW ‚ïê‚ïê‚ïê‚ïê -->
<div class="full-view" id="fv-rank">
  <div class="fv-head">
    <div class="fv-title-row"><span class="fv-title">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°</span></div>
  </div>
  <div class="fv-body">
    <div style="background:var(--navy);border-radius:var(--r);padding:18px;margin-bottom:16px;color:var(--white)">
      <div style="font-size:10px;color:rgba(255,255,255,.55);margin-bottom:4px;font-weight:700;text-transform:uppercase;letter-spacing:.6px">‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
      <div style="font-size:32px;font-weight:700;font-family:var(--mono);color:#fbbf24" id="rank-total">0</div>
      <div style="font-size:11px;color:rgba(255,255,255,.5);margin-top:4px">‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πà‡∏ß‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div>
    </div>
    <div class="sec-head">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
    <div id="lb-body"></div>
  </div>
</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay" onclick="closeAllPanels()"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê PANEL: REPORT WIZARD ‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-report">
  <div class="panel-handle-wrap"><div class="panel-handle"></div></div>
  <div class="panel-header">
    <div class="ph-left">
      <div class="ph-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1b3a6b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/><circle cx="12" cy="17" r="1" fill="#1b3a6b" stroke="none"/>
        </svg>
      </div>
      <div>
        <div class="panel-title">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏á‡∏ñ‡∏ô‡∏ô</div>
        <div class="panel-subtitle">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
      </div>
    </div>
    <button class="panel-close" onclick="closeAllPanels()">‚úï</button>
  </div>

  <!-- STEPPER -->
  <div class="wizard-stepper">
    <div class="step-track">
      <div class="step-node active" id="sn-1">1</div>
      <div class="step-connector" id="sc-1"></div>
      <div class="step-node" id="sn-2">2</div>
      <div class="step-connector" id="sc-2"></div>
      <div class="step-node" id="sn-3">3</div>
      <div class="step-connector" id="sc-3"></div>
      <div class="step-node" id="sn-4">4</div>
      <div class="step-connector" id="sc-4"></div>
      <div class="step-node" id="sn-5">5</div>
    </div>
    <div class="step-info">
      <span class="step-label-txt" id="step-lbl">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</span>
      <span class="step-counter-txt" id="step-ctr">1 / 5</span>
    </div>
  </div>

  <div class="panel-body">

    <!-- ‚ñë STEP 1: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå ‚ñë -->
    <div class="step-page active" id="sp-1">
      <div class="field-sect">
        <label class="field-label">‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå<span class="field-req">*</span></label>
        <div class="field-desc">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÄ‡∏´‡πá‡∏ô‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
      </div>
      <div class="event-opts">
        <button class="event-opt" data-sev="accident" onclick="selEventType(this)">
          <div class="ev-icon">üö®</div>
          <div class="ev-text"><div class="ev-title">‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡πâ‡∏ß</div><div class="ev-desc">‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ ‡∏Å‡∏≤‡∏£‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô</div></div>
          <div class="ev-radio" style="border-color:#c0392b"></div>
        </button>
        <button class="event-opt" data-sev="frequent" onclick="selEventType(this)">
          <div class="ev-icon">‚ö†Ô∏è</div>
          <div class="ev-text"><div class="ev-title">‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏ö‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div><div class="ev-desc">‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ</div></div>
          <div class="ev-radio" style="border-color:#e67e22"></div>
        </button>
        <button class="event-opt" data-sev="near" onclick="selEventType(this)">
          <div class="ev-icon">‚ö°</div>
          <div class="ev-text"><div class="ev-title">‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏</div><div class="ev-desc">‡πÄ‡∏â‡∏µ‡∏¢‡∏î‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div></div>
          <div class="ev-radio" style="border-color:#27ae60"></div>
        </button>
        <button class="event-opt" data-sev="observe" onclick="selEventType(this)">
          <div class="ev-icon">üëÅÔ∏è</div>
          <div class="ev-text"><div class="ev-title">‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div><div class="ev-desc">‡∏™‡∏†‡∏≤‡∏û‡∏ñ‡∏ô‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</div></div>
          <div class="ev-radio" style="border-color:#2563eb"></div>
        </button>
      </div>
      <div class="injury-sub" id="injury-sub">
        <label class="field-label" style="color:var(--red)">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á<span class="field-req">*</span></label>
        <div style="margin-top:8px">
          <div class="opts-2">
            <button class="opt-card" data-f="injury" data-v="fatal" onclick="selSingle(this,'injury')"><span class="opt-icon">üíÄ</span>‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</button>
            <button class="opt-card" data-f="injury" data-v="serious" onclick="selSingle(this,'injury')"><span class="opt-icon">üè•</span>‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡∏™‡∏≤‡∏´‡∏±‡∏™<br><small style="font-size:10px;color:var(--text-4)">‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô ‡∏£‡∏û.</small></button>
            <button class="opt-card" data-f="injury" data-v="minor" onclick="selSingle(this,'injury')"><span class="opt-icon">ü©π</span>‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</button>
            <button class="opt-card" data-f="injury" data-v="property" onclick="selSingle(this,'injury')"><span class="opt-icon">üí¢</span>‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ñë STEP 2: ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà + ‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞ ‚ñë -->
    <div class="step-page" id="sp-2">
      <div class="field-sect">
        <label class="field-label">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà<span class="field-req">*</span></label>
        <div class="field-desc">‡πÉ‡∏ä‡πâ GPS ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á</div>
      </div>
      <div class="gps-row">
        <button class="gps-btn" id="gps-btn" onclick="getGPS()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/>
            <line x1="12" y1="2" x2="12" y2="5"/><line x1="12" y1="19" x2="12" y2="22"/>
            <line x1="2" y1="12" x2="5" y2="12"/><line x1="19" y1="12" x2="22" y2="12"/>
          </svg>
          ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS
        </button>
        <div class="coord-box" id="coord-box">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0">
            <circle cx="12" cy="10" r="3"/><path d="M12 2a8 8 0 00-8 8c0 5 8 12 8 12s8-7 8-12a8 8 0 00-8-8z"/>
          </svg>
          <span class="coord-txt" id="coord-txt">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
        </div>
      </div>
      <div class="map-hint">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="10" r="3"/><path d="M12 2a8 8 0 00-8 8c0 5 8 12 8 12s8-7 8-12a8 8 0 00-8-8z"/></svg>
        ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
      </div>
      <div class="form-div"></div>
      <div class="field-sect">
        <label class="field-label">‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà<span class="field-req">*</span></label>
      </div>
      <div class="opts-3">
        <button class="opt-card" data-f="place" data-v="intersection" onclick="selSingle(this,'place')"><span class="opt-icon">üö¶</span>‡∏™‡∏µ‡πà‡πÅ‡∏¢‡∏Å</button>
        <button class="opt-card" data-f="place" data-v="tjunction" onclick="selSingle(this,'place')"><span class="opt-icon">‚ÜóÔ∏è</span>‡∏™‡∏≤‡∏°‡πÅ‡∏¢‡∏Å</button>
        <button class="opt-card" data-f="place" data-v="roundabout" onclick="selSingle(this,'place')"><span class="opt-icon">üîÑ</span>‡∏ß‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô</button>
        <button class="opt-card" data-f="place" data-v="curve" onclick="selSingle(this,'place')"><span class="opt-icon">‚Ü©Ô∏è</span>‡∏ó‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏á</button>
        <button class="opt-card" data-f="place" data-v="curve" onclick="selSingle(this,'place')"><span class="opt-icon">‚Ü©Ô∏è</span>‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏ñ</button>
        <button class="opt-card" data-f="place" data-v="straight" onclick="selSingle(this,'place')"><span class="opt-icon">‚û°Ô∏è</span>‡∏ó‡∏≤‡∏á‡∏ï‡∏£‡∏á</button>
        <button class="opt-card" data-f="place" data-v="slope" onclick="selSingle(this,'place')"><span class="opt-icon">‚õ∞Ô∏è</span>‡∏ó‡∏≤‡∏á‡∏•‡∏≤‡∏î‡∏ä‡∏±‡∏ô</button>
        <button class="opt-card" data-f="place" data-v="crosswalk" onclick="selSingle(this,'place')"><span class="opt-icon">üö∂</span>‡∏ó‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏ô</button>
        <button class="opt-card" data-f="place" data-v="school_zone" onclick="selSingle(this,'place')"><span class="opt-icon">üè´</span>‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        <button class="opt-card" data-f="place" data-v="bridge" onclick="selSingle(this,'place')"><span class="opt-icon">üåâ</span>‡∏™‡∏∞‡∏û‡∏≤‡∏ô</button>
        <button class="opt-card" data-f="place" data-v="highway" onclick="selSingle(this,'place')"><span class="opt-icon">üõ£Ô∏è</span>‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á</button>
        <button class="opt-card" data-f="place" data-v="alley" onclick="selSingle(this,'place')"><span class="opt-icon">üèòÔ∏è</span>‡∏ã‡∏≠‡∏¢/‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</button>
        <button class="opt-card" data-f="place" data-v="campus" onclick="selSingle(this,'place')"><span class="opt-icon">üéì</span>‡πÉ‡∏ô‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</button>
      </div>
      <div class="form-div"></div>
      <div class="field-sect">
        <label class="field-label">‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á <span style="font-weight:400;color:var(--text-4);text-transform:none">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)</span></label>
      </div>
      <div class="opts-4">
        <button class="opt-card" data-f="vehicles" data-v="motorcycle" onclick="selMulti(this,'vehicles')"><span class="opt-icon">üèçÔ∏è</span>‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ã‡∏Ñ‡πå</button>
        <button class="opt-card" data-f="vehicles" data-v="car" onclick="selMulti(this,'vehicles')"><span class="opt-icon">üöó</span>‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</button>
        <button class="opt-card" data-f="vehicles" data-v="truck" onclick="selMulti(this,'vehicles')"><span class="opt-icon">üöõ</span>‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å</button>
        <button class="opt-card" data-f="vehicles" data-v="bus" onclick="selMulti(this,'vehicles')"><span class="opt-icon">üöå</span>‡∏£‡∏ñ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£</button>
        <button class="opt-card" data-f="vehicles" data-v="bicycle" onclick="selMulti(this,'vehicles')"><span class="opt-icon">üö≤</span>‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô</button>
        <button class="opt-card" data-f="vehicles" data-v="tricycle" onclick="selMulti(this,'vehicles')"><span class="opt-icon">üõ∫</span>‡∏™‡∏≤‡∏°‡∏•‡πâ‡∏≠</button>
        <button class="opt-card" data-f="vehicles" data-v="pedestrian" onclick="selMulti(this,'vehicles')"><span class="opt-icon">üö∂</span>‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤</button>
        <button class="opt-card" data-f="vehicles" data-v="unknown" onclick="selMulti(this,'vehicles')"><span class="opt-icon">‚ùî</span>‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö</button>
      </div>
    </div>

    <!-- ‚ñë STEP 3: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö + ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ + ‡∏Å‡∏•‡∏∏‡πà‡∏° ‚ñë -->
    <div class="step-page" id="sp-3">
      <div class="field-sect">
        <label class="field-label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏<span class="field-req">*</span></label>
        <div class="field-desc">‡∏≠‡∏¥‡∏á: WHO 5 Pillars ‚Äî Post-accident Response</div>
      </div>
      <div class="opts-2">
        <button class="opt-card" data-f="incident" data-v="head_on" onclick="selSingle(this,'incident')"><span class="opt-icon">üí•</span>‡∏£‡∏ñ‡∏ä‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤</button>
        <button class="opt-card" data-f="incident" data-v="rear_end" onclick="selSingle(this,'incident')"><span class="opt-icon">‚Ü©Ô∏è</span>‡∏£‡∏ñ‡∏ä‡∏ô‡∏ó‡πâ‡∏≤‡∏¢</button>
        <button class="opt-card" data-f="incident" data-v="side_swipe" onclick="selSingle(this,'incident')"><span class="opt-icon">‚ÜîÔ∏è</span>‡∏£‡∏ñ‡∏ä‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á</button>
        <button class="opt-card" data-f="incident" data-v="hit_ped" onclick="selSingle(this,'incident')"><span class="opt-icon">üö∂</span>‡∏£‡∏ñ‡∏ä‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤</button>
        <button class="opt-card" data-f="incident" data-v="rollover" onclick="selSingle(this,'incident')"><span class="opt-icon">üåÄ</span>‡∏£‡∏ñ‡∏û‡∏•‡∏¥‡∏Å‡∏Ñ‡∏ß‡πà‡∏≥</button>
        <button class="opt-card" data-f="incident" data-v="run_off" onclick="selSingle(this,'incident')"><span class="opt-icon">üõ£Ô∏è</span>‡∏£‡∏ñ‡∏ï‡∏Å‡∏ñ‡∏ô‡∏ô/‡∏Ñ‡∏•‡∏≠‡∏á</button>
        <button class="opt-card" data-f="incident" data-v="fall_slip" onclick="selSingle(this,'incident')"><span class="opt-icon">üíß</span>‡∏•‡πâ‡∏° / ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏ñ‡∏•</button>
        <button class="opt-card" data-f="incident" data-v="hit_object" onclick="selSingle(this,'incident')"><span class="opt-icon">ü™®</span>‡∏ä‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á</button>
      </div>
      <div class="form-div"></div>
      <div class="field-sect">
        <label class="field-label">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô <span style="font-weight:400;color:var(--text-4);text-transform:none">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠)</span></label>
        <div class="field-desc">‡∏≠‡∏¥‡∏á: WHO 5 Pillars ‚Äî Safe Road Users + Safe Infrastructure</div>
      </div>
      <div class="opts-3">
        <button class="opt-card" data-f="causes" data-v="speeding" onclick="selMulti(this,'causes')"><span class="opt-icon">üèéÔ∏è</span>‡∏Ç‡∏±‡∏ö‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô</button>
        <button class="opt-card" data-f="causes" data-v="drunk" onclick="selMulti(this,'causes')"><span class="opt-icon">üç∫</span>‡∏™‡∏á‡∏™‡∏±‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡∏∏‡∏£‡∏≤</button>
        <button class="opt-card" data-f="causes" data-v="sleepy" onclick="selMulti(this,'causes')"><span class="opt-icon">üò¥</span>‡∏á‡πà‡∏ß‡∏á/‡πÄ‡∏´‡∏°‡πà‡∏≠‡∏•‡∏≠‡∏¢</button>
        <button class="opt-card" data-f="causes" data-v="distracted" onclick="selMulti(this,'causes')"><span class="opt-icon">üì±</span>‡πÉ‡∏ä‡πâ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Ç‡∏ì‡∏∞‡∏Ç‡∏±‡∏ö</button>
        <button class="opt-card" data-f="causes" data-v="red_light" onclick="selMulti(this,'causes')"><span class="opt-icon">üö¶</span>‡∏ù‡πà‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÑ‡∏ü‡πÅ‡∏î‡∏á</button>
        <button class="opt-card" data-f="causes" data-v="no_yield" onclick="selMulti(this,'causes')"><span class="opt-icon">‚õî</span>‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏á</button>
        <button class="opt-card" data-f="causes" data-v="low_vis" onclick="selMulti(this,'causes')"><span class="opt-icon">üå´Ô∏è</span>‡∏ó‡∏±‡∏®‡∏ô‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡∏ï‡πà‡∏≥</button>
        <button class="opt-card" data-f="causes" data-v="slippery" onclick="selMulti(this,'causes')"><span class="opt-icon">üåßÔ∏è</span>‡∏ñ‡∏ô‡∏ô‡∏•‡∏∑‡πà‡∏ô/‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°</button>
        <button class="opt-card" data-f="causes" data-v="no_light" onclick="selMulti(this,'causes')"><span class="opt-icon">üî¶</span>‡πÑ‡∏ü‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢</button>
        <button class="opt-card" data-f="causes" data-v="road_defect" onclick="selMulti(this,'causes')"><span class="opt-icon">üï≥Ô∏è</span>‡∏ñ‡∏ô‡∏ô‡∏ä‡∏≥‡∏£‡∏∏‡∏î/‡∏ö‡πà‡∏≠</button>
        <button class="opt-card" data-f="causes" data-v="no_sign" onclick="selMulti(this,'causes')"><span class="opt-icon">ü™ß</span>‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î</button>
        <button class="opt-card" data-f="causes" data-v="unknown" onclick="selMulti(this,'causes')"><span class="opt-icon">‚ùî</span>‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</button>
      </div>
      <div class="form-div"></div>
      <div class="field-sect">
        <label class="field-label">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á <span style="font-weight:400;color:var(--text-4);text-transform:none">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏°)</span></label>
        <div class="field-desc">‡∏≠‡∏¥‡∏á: Safe System ‚Äî Equity Framework (Johns Hopkins, 2023)</div>
      </div>
      <div class="opts-4">
        <button class="opt-card" data-f="groups" data-v="child" onclick="selMulti(this,'groups')"><span class="opt-icon">üë¶</span>‡πÄ‡∏î‡πá‡∏Å<br><small style="font-size:9.5px;color:var(--text-4)">&lt;15 ‡∏õ‡∏µ</small></button>
        <button class="opt-card" data-f="groups" data-v="elderly" onclick="selMulti(this,'groups')"><span class="opt-icon">üë¥</span>‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏<br><small style="font-size:9.5px;color:var(--text-4)">60+</small></button>
        <button class="opt-card" data-f="groups" data-v="student" onclick="selMulti(this,'groups')"><span class="opt-icon">üéì</span>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/<br>‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</button>
        <button class="opt-card" data-f="groups" data-v="disabled" onclick="selMulti(this,'groups')"><span class="opt-icon">‚ôø</span>‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏Å‡∏≤‡∏£/<br>‡∏ß‡∏µ‡∏•‡πÅ‡∏ä‡∏£‡πå</button>
        <button class="opt-card" data-f="groups" data-v="worker" onclick="selMulti(this,'groups')"><span class="opt-icon">üë∑</span>‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô</button>
        <button class="opt-card" data-f="groups" data-v="general" onclick="selMulti(this,'groups')"><span class="opt-icon">üë•</span>‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô<br>‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</button>
        <button class="opt-card" data-f="groups" data-v="tourist" onclick="selMulti(this,'groups')"><span class="opt-icon">üß≥</span>‡∏ô‡∏±‡∏Å‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</button>
        <button class="opt-card" data-f="groups" data-v="unknown" onclick="selMulti(this,'groups')"><span class="opt-icon">‚ùî</span>‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö</button>
      </div>
    </div>

    <!-- ‚ñë STEP 4: ‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏° ‚ñë -->
    <div class="step-page" id="sp-4">
      <div class="field-sect">
        <label class="field-label">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏<span class="field-req">*</span></label>
      </div>
      <div class="pill-row">
        <button class="pill-opt" data-f="time_slot" data-v="dawn" onclick="selSingle(this,'time_slot')">üåÖ ‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏ä‡πâ‡∏≤ (05‚Äì09‡∏ô.)</button>
        <button class="pill-opt" data-f="time_slot" data-v="morning" onclick="selSingle(this,'time_slot')">‚òÄÔ∏è ‡∏™‡∏≤‡∏¢ (09‚Äì12‡∏ô.)</button>
        <button class="pill-opt" data-f="time_slot" data-v="afternoon" onclick="selSingle(this,'time_slot')">üå§Ô∏è ‡∏ö‡πà‡∏≤‡∏¢ (12‚Äì16‡∏ô.)</button>
        <button class="pill-opt" data-f="time_slot" data-v="evening" onclick="selSingle(this,'time_slot')">üåÜ ‡πÄ‡∏¢‡πá‡∏ô (16‚Äì20‡∏ô.)</button>
        <button class="pill-opt" data-f="time_slot" data-v="night" onclick="selSingle(this,'time_slot')">üåô ‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô (20‚Äì01‡∏ô.)</button>
        <button class="pill-opt" data-f="time_slot" data-v="late_night" onclick="selSingle(this,'time_slot')">üåö ‡∏î‡∏∂‡∏Å (01‚Äì05‡∏ô.)</button>
      </div>
      <div class="form-div"></div>
      <div class="field-sect">
        <label class="field-label">‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®<span class="field-req">*</span></label>
      </div>
      <div class="opts-4">
        <button class="opt-card" data-f="weather" data-v="clear" onclick="selSingle(this,'weather')"><span class="opt-icon">‚òÄÔ∏è</span>‡πÅ‡∏î‡∏î‡∏à‡∏±‡∏î/‡∏õ‡∏Å‡∏ï‡∏¥</button>
        <button class="opt-card" data-f="weather" data-v="overcast" onclick="selSingle(this,'weather')"><span class="opt-icon">‚õÖ</span>‡∏°‡∏µ‡πÄ‡∏°‡∏Ü/‡∏Ñ‡∏£‡∏∂‡πâ‡∏°</button>
        <button class="opt-card" data-f="weather" data-v="rain" onclick="selSingle(this,'weather')"><span class="opt-icon">üåßÔ∏è</span>‡∏ù‡∏ô‡∏ï‡∏Å</button>
        <button class="opt-card" data-f="weather" data-v="fog" onclick="selSingle(this,'weather')"><span class="opt-icon">üå´Ô∏è</span>‡∏´‡∏°‡∏≠‡∏Å‡∏´‡∏ô‡∏≤</button>
      </div>
      <div class="form-div"></div>
      <div class="field-sect">
        <label class="field-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</label>
      </div>
      <div class="pill-row">
        <button class="pill-opt" data-f="day_type" data-v="weekday" onclick="selSingle(this,'day_type')">üìÖ ‡∏ß‡∏±‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (‡∏à‚Äì‡∏®)</button>
        <button class="pill-opt" data-f="day_type" data-v="weekend" onclick="selSingle(this,'day_type')">üóìÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡∏™‚Äì‡∏≠‡∏≤)</button>
        <button class="pill-opt" data-f="day_type" data-v="holiday" onclick="selSingle(this,'day_type')">üéâ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå</button>
      </div>
      <div class="form-div"></div>
      <div class="field-sect">
        <label class="field-label">‡∏Ç‡πâ‡∏≠‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô <span style="font-weight:400;color:var(--text-4);text-transform:none">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠)</span></label>
        <div class="field-desc">‡∏≠‡∏¥‡∏á: WHO 5 Pillars ‚Äî Safe Roads + Safe Infrastructure</div>
      </div>
      <div class="opts-3">
        <button class="opt-card" data-f="infra" data-v="no_signal" onclick="selMulti(this,'infra')"><span class="opt-icon">üö¶</span>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÑ‡∏ü</button>
        <button class="opt-card" data-f="infra" data-v="no_sign" onclick="selMulti(this,'infra')"><span class="opt-icon">ü™ß</span>‡∏Ç‡∏≤‡∏î‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
        <button class="opt-card" data-f="infra" data-v="no_barrier" onclick="selMulti(this,'infra')"><span class="opt-icon">üöß</span>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏á‡∏Å‡∏±‡πâ‡∏ô</button>
        <button class="opt-card" data-f="infra" data-v="no_sidewalk" onclick="selMulti(this,'infra')"><span class="opt-icon">üö∂</span>‡∏Ç‡∏≤‡∏î‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤</button>
        <button class="opt-card" data-f="infra" data-v="narrow" onclick="selMulti(this,'infra')"><span class="opt-icon">‚ÜîÔ∏è</span>‡∏ñ‡∏ô‡∏ô‡πÅ‡∏Ñ‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô</button>
        <button class="opt-card" data-f="infra" data-v="pothole" onclick="selMulti(this,'infra')"><span class="opt-icon">üï≥Ô∏è</span>‡∏ö‡πà‡∏≠/‡∏ñ‡∏ô‡∏ô‡∏û‡∏±‡∏á</button>
        <button class="opt-card" data-f="infra" data-v="faded_mark" onclick="selMulti(this,'infra')"><span class="opt-icon">üìè</span>‡πÄ‡∏™‡πâ‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏•‡∏ö</button>
        <button class="opt-card" data-f="infra" data-v="obstruction" onclick="selMulti(this,'infra')"><span class="opt-icon">ü™®</span>‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á</button>
        <button class="opt-card" data-f="infra" data-v="no_ramp" onclick="selMulti(this,'infra')"><span class="opt-icon">‚ôø</span>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏≤‡∏á‡∏•‡∏≤‡∏î</button>
      </div>
    </div>

    <!-- ‚ñë STEP 5: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î + ‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‚ñë -->
    <div class="step-page" id="sp-5">
      <div class="field-sect">
        <label class="field-label">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° <span style="font-weight:400;color:var(--text-4);text-transform:none">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span></label>
        <div class="field-desc">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</div>
      </div>
      <textarea class="form-ta" id="inp-desc" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏ö‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏•‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ ‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏ñ‡πÄ‡∏°‡∏•‡πå‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 50 ‡πÄ‡∏°‡∏ï‡∏£ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏ß‡∏¢‡∏Å‡∏±‡πâ‡∏ô..."></textarea>
      <div class="form-div"></div>
      <div class="field-sect">
        <label class="field-label">‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô <span style="font-weight:400;color:var(--text-4);text-transform:none">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span></label>
        <div class="field-desc">‡∏†‡∏≤‡∏û‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô</div>
      </div>
      <label class="photo-zone">
        <input type="file" id="photo-inp" accept="image/*" multiple onchange="handlePhoto(event)">
        <div class="pz-icon">üì∑</div>
        <div class="pz-title">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</div>
        <div class="pz-sub">JPG, PNG ‚Äî ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏£‡∏π‡∏õ</div>
        <div class="photo-previews" id="photo-prev"></div>
      </label>
      <div class="form-div"></div>
      <!-- Reporter info from login (auto-filled, read-only) -->
      <div style="background:var(--navy-xl);border:1px solid var(--navy-l);border-radius:var(--r-sm);padding:12px 14px;font-size:12px;color:var(--text-2);margin-bottom:8px">
        <div style="font-size:10px;font-weight:700;color:var(--navy);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏à‡∏≤‡∏Å Login)</div>
        <div id="rpt-user-info">‚Äî</div>
      </div>
      <div style="padding:11px 13px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r-sm);font-size:12px;color:var(--text-3);line-height:1.6">
        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏ñ‡∏ô‡∏ô ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢
      </div>
    </div>

  </div><!-- /panel-body -->

  <!-- WIZARD FOOTER -->
  <div class="wiz-footer active" id="wiz-footer">
    <button class="wf-back" id="wf-back" style="display:none" onclick="wizBack()">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    <button class="wf-next" id="wf-next" onclick="wizNext()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê PANEL: PROFILE ‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-profile">
  <div class="panel-handle-wrap"><div class="panel-handle"></div></div>
  <div class="panel-header">
    <div class="ph-left">
      <div class="ph-icon">üë§</div>
      <div>
        <div class="panel-title">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
        <div class="panel-subtitle">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
      </div>
    </div>
    <button class="panel-close" onclick="closeAllPanels()">‚úï</button>
  </div>
  <div class="panel-body">
    <div class="prof-card">
      <div class="pc-name" id="prof-name">‚Äî</div>
      <div class="pc-code" id="prof-code">‚Äî</div>
      <div class="pc-faculty" id="prof-faculty">‚Äî</div>
      <div class="pc-level" id="prof-level">‡∏£‡∏∞‡∏î‡∏±‡∏ö: ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô üå±</div>
      <div class="pc-stats">
        <div><div class="pcs-n" id="prof-pts">0</div><div class="pcs-l">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div></div>
        <div><div class="pcs-n" id="prof-reps">0</div><div class="pcs-l">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div></div>
        <div><div class="pcs-n" id="prof-votes">0</div><div class="pcs-l">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö</div></div>
      </div>
      <div class="pc-xp-bar"><div class="pc-xp-fill" id="xp-fill" style="width:0%"></div></div>
      <div class="pc-xp-lbl" id="xp-lbl">0 / 100 XP ‡∏™‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>
    </div>
    <div class="sec-head">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
    <div class="badge-grid" id="badge-grid"></div>
    <div class="form-div"></div>
    <div class="sec-head">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <div class="pts-table">
      <div class="pts-row"><span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</span><span class="pts-val">+10</span></div>
      <div class="pts-row"><span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô "‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏"</span><span class="pts-val">+10 ‡πÄ‡∏û‡∏¥‡πà‡∏°</span></div>
      <div class="pts-row"><span>‡πÅ‡∏ô‡∏ö‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</span><span class="pts-val">+5</span></div>
      <div class="pts-row"><span>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span><span class="pts-val">+5</span></div>
      <div class="pts-row"><span>‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</span><span class="pts-val">+20</span></div>
    </div>
    <div style="height:16px"></div>
    <button onclick="doLogout()" style="width:100%;padding:12px;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--r-sm);font-family:var(--font);font-size:13px;font-weight:600;color:var(--text-3);cursor:pointer;margin-bottom:8px">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>
</div>

</div><!-- /app -->

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG ‚Äî ‡πÅ‡∏Å‡πâ URL ‡∏´‡∏•‡∏±‡∏á deploy Google Apps Script
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GAS_URL = localStorage.getItem('sr_gas_url') || 'YOUR_GAS_URL_HERE';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FACULTY MAP (‡∏£‡∏´‡∏±‡∏™ 2 ‡∏ï‡∏±‡∏ß ‚Üí ‡∏Ñ‡∏ì‡∏∞)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FACULTY_MAP = {
  '01':'‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏∏‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå',
  '02':'‡∏Ñ‡∏ì‡∏∞‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå',
  '03':'‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£',
  '04':'‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ',
  '05':'‡∏Ñ‡∏ì‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£',
  '06':'‡∏Ñ‡∏ì‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°',
  '07':'‡∏Ñ‡∏ì‡∏∞‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô',
  '08':'‡∏Ñ‡∏ì‡∏∞‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå',
  '09':'‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ / ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå',
  '10':'‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£',
  '11':'‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ó‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
  '12':'‡∏Å‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤',
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const APP = {
  user:    null, // { studentId, faculty, facultyCode, name, pts }
  reports: [],
  form:    {},
  step:    1,
  lat:     null, lng: null,
  photos:  [],
  filter:  'all',
  mapMode: 'pin',
  pinLayers:    [],
  heatLayer:    null,
  clusterGroup: null,
  tempMarker:   null,
};

const TOTAL_STEPS = 5;
const STEP_LABELS = [
  '',
  '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå',
  '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞',
  '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡∏ï‡∏∏ ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á',
  '‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô',
  '‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
];

const SEV_COLOR = { accident:'#c0392b', frequent:'#e67e22', near:'#27ae60', observe:'#2563eb' };
const SEV_LABEL = { accident:'‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡πâ‡∏ß', frequent:'‡πÄ‡∏Å‡∏¥‡∏î‡∏ö‡πà‡∏≠‡∏¢/‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á', near:'‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏', observe:'‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á' };
const SEV_ICON  = { accident:'üö®', frequent:'‚ö†Ô∏è', near:'‚ö°', observe:'üëÅÔ∏è' };

const PLACE_LABEL = { intersection:'‡∏™‡∏µ‡πà‡πÅ‡∏¢‡∏Å', tjunction:'‡πÅ‡∏¢‡∏Å T', roundabout:'‡∏ß‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô', curve:'‡πÇ‡∏Ñ‡πâ‡∏á‡∏ñ‡∏ô‡∏ô', straight:'‡∏ó‡∏≤‡∏á‡∏ï‡∏£‡∏á', slope:'‡∏ó‡∏≤‡∏á‡∏•‡∏≤‡∏î', crosswalk:'‡∏ó‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏ô', school_zone:'‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', bridge:'‡∏™‡∏∞‡∏û‡∏≤‡∏ô', highway:'‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á', alley:'‡∏ã‡∏≠‡∏¢/‡∏ä‡∏∏‡∏°‡∏ä‡∏ô', campus:'‡πÉ‡∏ô‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢' };
const INCIDENT_LABEL = { head_on:'‡∏£‡∏ñ‡∏ä‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤', rear_end:'‡∏£‡∏ñ‡∏ä‡∏ô‡∏ó‡πâ‡∏≤‡∏¢', side_swipe:'‡∏£‡∏ñ‡∏ä‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á', hit_ped:'‡∏£‡∏ñ‡∏ä‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏ô', rollover:'‡∏£‡∏ñ‡∏û‡∏•‡∏¥‡∏Å‡∏Ñ‡∏ß‡πà‡∏≥', run_off:'‡∏£‡∏ñ‡∏ï‡∏Å‡∏ñ‡∏ô‡∏ô', fall_slip:'‡∏•‡πâ‡∏°/‡∏•‡∏∑‡πà‡∏ô', hit_object:'‡∏ä‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á' };
const CAUSE_LABEL = { speeding:'‡∏Ç‡∏±‡∏ö‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô', drunk:'‡∏™‡∏á‡∏™‡∏±‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡∏∏‡∏£‡∏≤', sleepy:'‡∏á‡πà‡∏ß‡∏á/‡πÄ‡∏´‡∏°‡πà‡∏≠‡∏•‡∏≠‡∏¢', distracted:'‡πÉ‡∏ä‡πâ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', red_light:'‡∏ù‡πà‡∏≤‡πÑ‡∏ü‡πÅ‡∏î‡∏á', no_yield:'‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏á', low_vis:'‡∏ó‡∏±‡∏®‡∏ô‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡∏ï‡πà‡∏≥', slippery:'‡∏ñ‡∏ô‡∏ô‡∏•‡∏∑‡πà‡∏ô', no_light:'‡πÑ‡∏ü‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢', road_defect:'‡∏ñ‡∏ô‡∏ô‡∏ä‡∏≥‡∏£‡∏∏‡∏î', no_sign:'‡∏õ‡πâ‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î', unknown:'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö' };
const VEH_LABEL = { motorcycle:'‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ã‡∏Ñ‡πå', car:'‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', truck:'‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å', bus:'‡∏£‡∏ñ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£', bicycle:'‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô', tricycle:'‡∏™‡∏≤‡∏°‡∏•‡πâ‡∏≠', pedestrian:'‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤', unknown:'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö' };
const TIME_LABEL = { dawn:'‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏ä‡πâ‡∏≤', morning:'‡∏™‡∏≤‡∏¢', afternoon:'‡∏ö‡πà‡∏≤‡∏¢', evening:'‡πÄ‡∏¢‡πá‡∏ô', night:'‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô', late_night:'‡∏î‡∏∂‡∏Å' };

const BADGE_DEFS = [
  { id:'first',    icon:'üå±', name:'‡∏Å‡πâ‡∏≤‡∏ß‡πÅ‡∏£‡∏Å',      req: n=>n>=1 },
  { id:'explorer', icon:'üîç', name:'‡∏ô‡∏±‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à',     req: n=>n>=5 },
  { id:'guardian', icon:'üõ°Ô∏è', name:'‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå',   req: n=>n>=20 },
  { id:'hero',     icon:'‚≠ê', name:'‡∏ß‡∏µ‡∏£‡∏ö‡∏∏‡∏£‡∏∏‡∏©',     req: n=>n>=50 },
  { id:'nearmiss', icon:'‚ö°', name:'Near-Miss Pro',  req: _=>APP.reports.filter(r=>r.sev==='near').length>=3 },
  { id:'photo',    icon:'üì∑', name:'‡∏ô‡∏±‡∏Å‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û',   req: _=>APP.reports.some(r=>r.hasPhoto) },
  { id:'equity',   icon:'‚ôø', name:'Equity Guard',  req: _=>APP.reports.some(r=>(r.groups||[]).includes('disabled')) },
  { id:'campus',   icon:'üéì', name:'Campus Safety', req: _=>APP.reports.some(r=>r.place==='campus') },
];
const LEVELS = [
  {min:0,  max:100,  label:'‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô',      icon:'üå±'},
  {min:100,max:300,  label:'‡∏ô‡∏±‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à',         icon:'üîç'},
  {min:300,max:700,  label:'‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡∏ñ‡∏ô‡∏ô',    icon:'üõ°Ô∏è'},
  {min:700,max:1500, label:'‡∏ß‡∏µ‡∏£‡∏ö‡∏∏‡∏£‡∏∏‡∏©‡∏ñ‡∏ô‡∏ô',      icon:'‚≠ê'},
  {min:1500,max:99999,label:'‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢',icon:'üèÜ'},
];
const AV_CLR = ['#1b3a6b','#1a7a4a','#b7560a','#c0392b','#7c3aed'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onStudentIdInput(inp) {
  const val = inp.value.replace(/\D/g,'');
  inp.value = val;
  const err = document.getElementById('id-error');
  const det = document.getElementById('faculty-detected');
  const detTxt = document.getElementById('faculty-detected-text');
  const sel  = document.getElementById('sel-faculty');
  inp.classList.remove('error');
  err.classList.remove('show');
  det.classList.remove('show');
  if (val.length === 10) {
    const code   = val.substring(2,4);
    const faculty = FACULTY_MAP[code];
    if (faculty) {
      detTxt.textContent = '‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö: ' + faculty;
      det.classList.add('show');
      // Auto-select faculty dropdown
      for (let i=0; i<sel.options.length; i++) {
        if (sel.options[i].value === code) { sel.selectedIndex = i; break; }
      }
    }
  }
}

function validateStudentId() {
  const val = document.getElementById('inp-student-id').value;
  const err = document.getElementById('id-error');
  if (val.length > 0 && val.length !== 10) {
    err.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 10 ‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 6812207001)';
    err.classList.add('show');
    document.getElementById('inp-student-id').classList.add('error');
    return false;
  }
  return true;
}

function doLogin() {
  const sid    = document.getElementById('inp-student-id').value.trim();
  const facVal = document.getElementById('sel-faculty').value;
  const name   = document.getElementById('inp-fullname').value.trim();
  const btn    = document.getElementById('login-btn');

  // Validate
  let ok = true;
  const sidErr = document.getElementById('id-error');
  const facErr = document.getElementById('faculty-error');
  sidErr.classList.remove('show');
  facErr.classList.remove('show');

  if (sid.length === 0) {
    sidErr.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
    sidErr.classList.add('show');
    document.getElementById('inp-student-id').classList.add('error');
    ok = false;
  } else if (sid.length !== 10) {
    sidErr.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 10 ‡∏´‡∏•‡∏±‡∏Å';
    sidErr.classList.add('show');
    document.getElementById('inp-student-id').classList.add('error');
    ok = false;
  }
  if (!facVal) {
    facErr.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ì‡∏∞‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô';
    facErr.classList.add('show');
    ok = false;
  }
  if (!ok) return;

  btn.disabled = true;
  btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';

  const faculty = FACULTY_MAP[facVal] || document.getElementById('sel-faculty').options[document.getElementById('sel-faculty').selectedIndex].text;
  APP.user = {
    studentId:   sid,
    facultyCode: facVal,
    faculty:     faculty,
    name:        name || sid,
    pts:         0,
  };

  // Save to localStorage
  localStorage.setItem('sr_user', JSON.stringify(APP.user));

  setTimeout(() => {
    document.getElementById('login-screen').classList.add('hide');
    document.getElementById('app').classList.add('show');
    initApp();
    btn.disabled = false;
    btn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
  }, 600);
}

function doLogout() {
  localStorage.removeItem('sr_user');
  APP.user = null;
  closeAllPanels();
  document.getElementById('login-screen').classList.remove('hide');
  document.getElementById('app').classList.remove('show');
  document.getElementById('inp-student-id').value = '';
  document.getElementById('sel-faculty').selectedIndex = 0;
  document.getElementById('inp-fullname').value = '';
  document.getElementById('faculty-detected').classList.remove('show');
  document.getElementById('id-error').classList.remove('show');
  toast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let map;
function initMap() {
  if (map) return;
  map = L.map('map', { zoomControl:false }).setView([16.82, 100.26], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'¬© OpenStreetMap contributors', maxZoom:19
  }).addTo(map);
  L.control.zoom({ position:'topright' }).addTo(map);
  map.on('click', e => {
    setCoord(e.latlng.lat, e.latlng.lng);
    if (!document.getElementById('panel-report').classList.contains('open')) openReportPanel();
  });
}

function mkIcon(sev) {
  const c = SEV_COLOR[sev] || '#e67e22';
  const i = SEV_ICON[sev]  || '‚ö†Ô∏è';
  return L.divIcon({
    className:'',
    html:`<div style="width:34px;height:34px;background:${c};border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:2.5px solid rgba(255,255,255,.85);box-shadow:0 3px 12px ${c}55;display:flex;align-items:center;justify-content:center"><span style="transform:rotate(45deg);font-size:14px;line-height:1">${i}</span></div>`,
    iconSize:[34,34], iconAnchor:[17,34],
  });
}

function mkPopup(r) {
  const c   = SEV_COLOR[r.sev] || '#e67e22';
  const tags = [
    ...(r.vehicles||[]).map(v=>VEH_LABEL[v]||v),
    ...(r.causes||[]).slice(0,2).map(v=>CAUSE_LABEL[v]||v),
  ].filter(Boolean).slice(0,4);
  return `<div class="map-popup">
    <div class="mp-header">
      <div class="mp-sev-bar" style="background:${c};min-height:30px"></div>
      <div>
        <div class="mp-title">${PLACE_LABEL[r.place]||'‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á'}</div>
        <span class="mp-badge" style="background:${c}18;color:${c}">${SEV_LABEL[r.sev]||r.sev}</span>
      </div>
    </div>
    ${tags.length?`<div class="mp-tags">${tags.map(t=>`<span class="mp-tag">${t}</span>`).join('')}</div>`:''}
    ${r.desc?`<div class="mp-desc">${r.desc}</div>`:''}
    <div class="mp-meta">${r.faculty||''} ¬∑ ${r.time_label||''} ¬∑ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ${r.votes||0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
  </div>`;
}

function setMapMode(mode) {
  APP.mapMode = mode;
  ['pin','heat','cluster'].forEach(m => {
    const b = document.getElementById('mb-'+m);
    if(b) b.classList.toggle('active', m===mode);
  });
  APP.pinLayers.forEach(l=>{try{map.removeLayer(l)}catch(e){}});
  APP.pinLayers=[];
  if(APP.heatLayer){try{map.removeLayer(APP.heatLayer)}catch(e){}; APP.heatLayer=null;}
  if(APP.clusterGroup){try{map.removeLayer(APP.clusterGroup)}catch(e){}; APP.clusterGroup=null;}
  const valid = APP.reports.filter(r=>r.lat&&r.lng);
  if (mode==='pin') {
    valid.forEach(r => {
      const m = L.marker([+r.lat,+r.lng],{icon:mkIcon(r.sev)}).addTo(map);
      m.bindPopup(mkPopup(r),{maxWidth:290}); APP.pinLayers.push(m);
    });
  } else if (mode==='heat') {
    const wt={accident:1.0,frequent:.65,near:.4,observe:.25};
    const pts=valid.map(r=>[+r.lat,+r.lng,wt[r.sev]||.3]);
    if(pts.length) APP.heatLayer=L.heatLayer(pts,{radius:38,blur:28,maxZoom:16,gradient:{0.2:'#27ae60',0.5:'#e67e22',0.8:'#c0392b',1.0:'#7f1d1d'}}).addTo(map);
  } else {
    APP.clusterGroup=L.markerClusterGroup({iconCreateFunction:cl=>{
      return L.divIcon({html:`<div style="width:40px;height:40px;background:#1b3a6b;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:13px;font-weight:700;color:white;box-shadow:0 2px 10px rgba(27,58,107,.3);border:2.5px solid rgba(255,255,255,.8)">${cl.getChildCount()}</div>`,className:'',iconSize:[40,40]});
    }});
    valid.forEach(r=>{const m=L.marker([+r.lat,+r.lng],{icon:mkIcon(r.sev)});m.bindPopup(mkPopup(r),{maxWidth:290});APP.clusterGroup.addLayer(m);});
    map.addLayer(APP.clusterGroup);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getGPS() {
  const btn = document.getElementById('gps-btn');
  btn.classList.add('loading'); btn.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏...';
  if (!navigator.geolocation) { resetGpsBtn(); toast('‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS','err'); return; }
  navigator.geolocation.getCurrentPosition(p=>{
    setCoord(p.coords.latitude, p.coords.longitude);
    map.flyTo([p.coords.latitude,p.coords.longitude],17,{duration:1.2});
    btn.classList.remove('loading'); btn.textContent='‚úì ‡πÑ‡∏î‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß';
    toast('‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','ok');
  }, ()=>{ resetGpsBtn(); toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ','err'); }, {enableHighAccuracy:true,timeout:12000});
}
function resetGpsBtn(){const b=document.getElementById('gps-btn');b.classList.remove('loading');b.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><line x1="12" y1="2" x2="12" y2="5"/><line x1="12" y1="19" x2="12" y2="22"/><line x1="2" y1="12" x2="5" y2="12"/><line x1="19" y1="12" x2="22" y2="12"/></svg> ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS';}
function doGPS(){if(!navigator.geolocation)return;navigator.geolocation.getCurrentPosition(p=>map.flyTo([p.coords.latitude,p.coords.longitude],17));}
function setCoord(lat,lng){
  APP.lat=lat;APP.lng=lng;
  const box=document.getElementById('coord-box');const txt=document.getElementById('coord-txt');
  if(box)box.classList.add('set'); if(txt)txt.textContent=`${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  if(APP.tempMarker)map.removeLayer(APP.tempMarker);
  APP.tempMarker=L.circleMarker([lat,lng],{radius:8,fillColor:'#1b3a6b',fillOpacity:.35,color:'#1b3a6b',weight:2}).addTo(map);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORM SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selEventType(el){
  document.querySelectorAll('.event-opt').forEach(b=>b.classList.remove('sel'));
  el.classList.add('sel'); APP.form.sev=el.dataset.sev;
  const inj=document.getElementById('injury-sub');
  inj.classList.toggle('show', APP.form.sev==='accident');
  if(APP.form.sev!=='accident') delete APP.form.injury;
}
function selSingle(el,f){
  document.querySelectorAll(`[data-f="${f}"]`).forEach(b=>b.classList.remove('sel'));
  el.classList.add('sel'); APP.form[f]=el.dataset.v;
}
function selMulti(el,f){
  el.classList.toggle('sel');
  if(!Array.isArray(APP.form[f]))APP.form[f]=[];
  const v=el.dataset.v;
  if(el.classList.contains('sel')){if(!APP.form[f].includes(v))APP.form[f].push(v);}
  else APP.form[f]=APP.form[f].filter(x=>x!==v);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WIZARD NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function wizNext(){
  const v=APP.form;
  if(APP.step===1){
    if(!v.sev) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå','err');
    if(v.sev==='accident'&&!v.injury) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á','err');
  }
  if(APP.step===2){
    if(!APP.lat||!APP.lng) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢ GPS ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà','err');
    if(!v.place) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà','err');
  }
  if(APP.step===3&&!v.incident) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏','err');
  if(APP.step===4){
    if(!v.time_slot) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤','err');
    if(!v.weather) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®','err');
  }
  if(APP.step===TOTAL_STEPS){submitReport();return;}
  APP.step++; renderWiz();
}
function wizBack(){if(APP.step<=1)return;APP.step--;renderWiz();}

function renderWiz(){
  const step=APP.step;
  document.querySelectorAll('.step-page').forEach((p,i)=>p.classList.toggle('active',i+1===step));
  for(let i=1;i<=TOTAL_STEPS;i++){
    const n=document.getElementById('sn-'+i);
    n.classList.remove('active','done');
    if(i<step){n.classList.add('done');n.innerHTML='<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';}
    else if(i===step){n.classList.add('active');n.textContent=i;}
    else n.textContent=i;
    if(i<TOTAL_STEPS){const c=document.getElementById('sc-'+i);if(c)c.classList.toggle('done',i<step);}
  }
  const lbl=document.getElementById('step-lbl');const ctr=document.getElementById('step-ctr');
  if(lbl)lbl.textContent=STEP_LABELS[step]||'';
  if(ctr)ctr.textContent=`${step} / ${TOTAL_STEPS}`;
  const back=document.getElementById('wf-back');const next=document.getElementById('wf-next');
  if(back)back.style.display=step>1?'block':'none';
  if(next){
    if(step===TOTAL_STEPS){next.textContent='‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';next.className='wf-next submit';}
    else{next.textContent='‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí';next.className='wf-next';}
  }
  // Show reporter info on step 5
  if(step===5){
    const ri=document.getElementById('rpt-user-info');
    if(ri&&APP.user) ri.innerHTML=`<strong>${APP.user.name}</strong> ¬∑ ${APP.user.studentId} ¬∑ ${APP.user.faculty}`;
  }
  document.querySelector('#panel-report .panel-body')?.scrollTo({top:0,behavior:'smooth'});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHOTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handlePhoto(e){
  const files=Array.from(e.target.files).slice(0,3);APP.photos=files;
  const prev=document.getElementById('photo-prev');if(!prev)return;
  prev.innerHTML='';
  files.forEach(f=>{const r=new FileReader();r.onload=ev=>{const img=document.createElement('img');img.src=ev.target.result;img.className='photo-thumb anim-in';prev.appendChild(img);};r.readAsDataURL(f);});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUBMIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function submitReport(){
  const next=document.getElementById('wf-next');
  next.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; next.classList.add('loading');
  const now=new Date();
  const report={
    id:          now.getTime().toString(),
    lat:         APP.lat, lng:APP.lng,
    sev:         APP.form.sev,
    injury:      APP.form.injury||'',
    place:       APP.form.place||'',
    vehicles:    APP.form.vehicles||[],
    incident:    APP.form.incident||'',
    causes:      APP.form.causes||[],
    groups:      APP.form.groups||[],
    infra:       APP.form.infra||[],
    time_slot:   APP.form.time_slot||'',
    time_label:  TIME_LABEL[APP.form.time_slot]||'',
    weather:     APP.form.weather||'',
    day_type:    APP.form.day_type||'',
    desc:        document.getElementById('inp-desc')?.value.trim()||'',
    studentId:   APP.user?.studentId||'',
    reporter:    APP.user?.name||'',
    faculty:     APP.user?.faculty||'',
    facultyCode: APP.user?.facultyCode||'',
    hasPhoto:    APP.photos.length>0,
    votes:0, status:'pending',
    createdAt:   now.toLocaleString('th-TH',{dateStyle:'short',timeStyle:'short'}),
    timestamp:   now.toISOString(),
  };
  APP.reports.push(report); saveLocal();
  setMapMode(APP.mapMode);
  let pts=10;
  if(report.sev==='near')pts+=10;
  if(APP.photos.length>0)pts+=5;
  addPoints(pts); checkBadges();
  sendGAS(report);
  resetForm();
  next.textContent='‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô'; next.classList.remove('loading');
  updateStats(); renderList(); renderLB();
  toast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${pts} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`,'ok');
  setTimeout(closeAllPanels,1200);
}

async function sendGAS(r){
  if(!GAS_URL||GAS_URL==='YOUR_GAS_URL_HERE')return;
  try{
    const fd=new FormData(); fd.append('action','addReport'); fd.append('data',JSON.stringify(r));
    await fetch(GAS_URL,{method:'POST',body:fd});
  }catch(e){}
}

function resetForm(){
  APP.form={};APP.step=1;APP.photos=[];APP.lat=null;APP.lng=null;
  document.querySelectorAll('.event-opt,.opt-card,.pill-opt').forEach(b=>b.classList.remove('sel'));
  document.getElementById('injury-sub').classList.remove('show');
  const desc=document.getElementById('inp-desc'); if(desc)desc.value='';
  const coord=document.getElementById('coord-box'); if(coord)coord.classList.remove('set');
  const ctxt=document.getElementById('coord-txt'); if(ctxt)ctxt.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
  const pprev=document.getElementById('photo-prev'); if(pprev)pprev.innerHTML='';
  if(APP.tempMarker){map.removeLayer(APP.tempMarker);APP.tempMarker=null;}
  resetGpsBtn(); renderWiz();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VOTE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function vote(id,el){
  const r=APP.reports.find(x=>x.id===id);
  if(!r||r._voted){toast('‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß','err');return;}
  r.votes=(r.votes||0)+1; r._voted=true;
  el.classList.add('voted'); el.textContent=`‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ${r.votes}`;
  if(r.studentId===APP.user?.studentId)addPoints(5);
  saveLocal(); renderList(); updateStats();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderList(){
  const f=APP.filter;
  const rows=f==='all'?APP.reports:APP.reports.filter(r=>r.sev===f);
  const body=document.getElementById('list-body');
  const cnt=document.getElementById('list-count');
  if(cnt)cnt.textContent=rows.length;
  if(!rows.length){if(body)body.innerHTML='<div class="empty-state"><div class="empty-ico">üìã</div><div class="empty-txt">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div></div>';return;}
  if(!body)return;
  body.innerHTML=[...rows].reverse().map(r=>{
    const c=SEV_COLOR[r.sev]||'#e67e22';
    const tags=[PLACE_LABEL[r.place]||'',...(r.vehicles||[]).slice(0,2).map(v=>VEH_LABEL[v]||v),...(r.causes||[]).slice(0,1).map(v=>CAUSE_LABEL[v]||v)].filter(Boolean);
    return `<div class="rcard anim-in" onclick="flyCard(${r.lat},${r.lng})">
      <div class="rc-bar" style="background:${c}"></div>
      <div class="rc-body">
        <div class="rc-top">
          <div class="rc-type">${SEV_ICON[r.sev]} ${PLACE_LABEL[r.place]||'‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á'}</div>
          <span class="rc-sev" style="background:${c}15;color:${c}">${SEV_LABEL[r.sev]||r.sev}</span>
        </div>
        ${tags.length?`<div class="rc-tags">${tags.map(t=>`<span class="rc-tag">${t}</span>`).join('')}</div>`:''}
        <div class="rc-desc">${r.desc||(INCIDENT_LABEL[r.incident]||'')||'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'}</div>
        <div class="rc-foot">
          <span>${r.faculty||''}</span><span>${r.time_label||''}</span>
          <button class="rc-vote ${r._voted?'voted':''}" onclick="event.stopPropagation();vote('${r.id}',this)">${r._voted?`‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ${r.votes||1}`:`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ${r.votes||0}`}</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function filterList(f,el){
  APP.filter=f;
  document.querySelectorAll('.fchip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active'); renderList();
}
function flyCard(lat,lng){showView('map');setTimeout(()=>map.flyTo([lat,lng],17,{duration:1}),100);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStats(){
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v};
  set('h-a',APP.reports.filter(r=>r.sev==='accident').length);
  set('h-f',APP.reports.filter(r=>r.sev==='frequent').length);
  set('h-n',APP.reports.filter(r=>r.sev==='near').length);
  set('rank-total',APP.reports.length);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAMIFICATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addPoints(n){
  if(!APP.user)return;
  APP.user.pts=(APP.user.pts||0)+n;
  saveUser(); updateUserUI();
}
function updateUserUI(){
  if(!APP.user)return;
  const u=APP.user; const pts=u.pts||0;
  const lv=LEVELS.find(l=>pts>=l.min&&pts<l.max)||LEVELS[LEVELS.length-1];
  const pct=Math.min(100,((pts-lv.min)/(lv.max-lv.min))*100);
  const next=LEVELS[LEVELS.indexOf(lv)+1];
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v};
  const av=document.getElementById('hdr-av');
  if(av)av.textContent=(u.name||'?')[0].toUpperCase();
  const hn=document.getElementById('hdr-name');if(hn)hn.textContent=u.name||u.studentId;
  const hp=document.getElementById('hdr-pts');if(hp)hp.textContent=`${pts} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`;
  set('prof-name',u.name||u.studentId);
  set('prof-code',u.studentId);
  set('prof-faculty',u.faculty);
  set('prof-level',`‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${lv.label} ${lv.icon}`);
  set('prof-pts',pts);
  set('prof-reps',APP.reports.filter(r=>r.studentId===u.studentId).length);
  set('prof-votes',APP.reports.reduce((a,r)=>a+(r.votes||0),0));
  const xf=document.getElementById('xp-fill');if(xf)xf.style.width=pct+'%';
  set('xp-lbl',`${pts-lv.min} / ${lv.max-lv.min} XP ‚Üí ${next?next.label:'‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î'}`);
}
function checkBadges(){
  const earned=JSON.parse(localStorage.getItem('sr_badges')||'[]');
  let changed=false;
  BADGE_DEFS.forEach(b=>{
    if(!earned.includes(b.id)&&b.req(APP.reports.length)){
      earned.push(b.id);changed=true;
      setTimeout(()=>toast(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç: ${b.icon} ${b.name}`,'ok'),700);
    }
  });
  if(changed)localStorage.setItem('sr_badges',JSON.stringify(earned));
  renderBadges(earned);
}
function renderBadges(earned){
  const g=document.getElementById('badge-grid');if(!g)return;
  g.innerHTML=BADGE_DEFS.map(b=>`<div class="badge-card ${earned.includes(b.id)?'earned':'locked'}"><span class="badge-icon">${b.icon}</span><div class="badge-name">${b.name}</div></div>`).join('');
}
function renderLB(){
  const byId={};
  APP.reports.forEach(r=>{
    const k=r.studentId||r.reporter||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    if(!byId[k])byId[k]={name:r.reporter||r.studentId||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',faculty:r.faculty||'',pts:0,cnt:0};
    byId[k].pts+=10+(r.sev==='near'?10:0)+(r.hasPhoto?5:0);
    byId[k].cnt++;
  });
  const sorted=Object.values(byId).sort((a,b)=>b.pts-a.pts);
  const body=document.getElementById('lb-body');if(!body)return;
  if(!sorted.length){body.innerHTML='<div class="empty-state"><div class="empty-ico">üèÜ</div><div class="empty-txt">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div></div>';return;}
  const medals=['ü•á','ü•à','ü•â'];
  body.innerHTML=sorted.map((u,i)=>`<div class="lb-card">
    <div class="lb-rank">${medals[i]||(i+1)}</div>
    <div class="lb-av" style="background:${AV_CLR[i%AV_CLR.length]}">${u.name[0].toUpperCase()}</div>
    <div class="lb-info"><div class="lb-name">${u.name}</div><div class="lb-sub">${u.faculty} ¬∑ ${u.cnt} ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div></div>
    <div class="lb-pts">${u.pts}</div>
  </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveLocal(){localStorage.setItem('sr_v5_reports',JSON.stringify(APP.reports));}
function saveUser(){if(APP.user)localStorage.setItem('sr_user',JSON.stringify(APP.user));}
function loadLocal(){
  const r=localStorage.getItem('sr_v5_reports');if(r)APP.reports=JSON.parse(r);
  const u=localStorage.getItem('sr_user');if(u)APP.user=JSON.parse(u);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PANEL & VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openReportPanel(){
  closeAllPanels();
  document.getElementById('panel-report').classList.add('open');
  document.getElementById('overlay').classList.add('open');
  document.getElementById('wiz-footer').classList.add('active');
}
function openPanel(name){
  closeAllPanels();
  const p=document.getElementById('panel-'+name);if(p)p.classList.add('open');
  document.getElementById('overlay').classList.add('open');
}
function closeAllPanels(){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('open'));
  document.getElementById('overlay').classList.remove('open');
  document.getElementById('wiz-footer').classList.remove('active');
}
function showView(name,el){
  ['list','rank'].forEach(v=>{const fv=document.getElementById('fv-'+v);if(fv)fv.classList.toggle('open',v===name);});
  document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
  if(el&&el.classList.contains('nav-item'))el.classList.add('active');
  else{const ids={map:'ni-map',list:'ni-list',rank:'ni-rank'};const ni=document.getElementById(ids[name]);if(ni)ni.classList.add('active');}
  if(name==='list')renderList();
  if(name==='rank')renderLB();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg,type=''){
  const el=document.getElementById('toast');if(!el)return;
  el.textContent=msg; el.className='toast'+(type?' '+type:'');
  el.classList.add('show');
  clearTimeout(el._t);el._t=setTimeout(()=>el.classList.remove('show'),3500);
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initApp(){
  initMap();
  loadLocal();
  if(APP.reports.length===0)addDemoData();
  updateUserUI(); updateStats();
  setMapMode('pin'); renderList(); renderLB();
  const badges=JSON.parse(localStorage.getItem('sr_badges')||'[]');
  renderBadges(badges);
}

// Check if already logged in
window.addEventListener('DOMContentLoaded',()=>{
  const saved=localStorage.getItem('sr_user');
  if(saved){
    APP.user=JSON.parse(saved);
    document.getElementById('login-screen').classList.add('hide');
    document.getElementById('app').classList.add('show');
    initApp();
  }
});
</script>
</body>
</html>
